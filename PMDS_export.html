<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mitsubishi ASA Export → Convert → Import to PMDS</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #60a5fa;
      --accent-2: #93c5fd;
      --border: #1f2937;
      --danger: #fca5a5;
      --ok: #86efac;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: linear-gradient(160deg, var(--bg), #0b1226 60%);
    }
    .container { max-width: 980px; margin: 0 auto; padding: 2rem 1.25rem 4rem; }
    header { text-align: center; margin-bottom: 2rem; }
    h1 { font-size: clamp(1.6rem, 1.2rem + 2vw, 2.25rem); margin: 0 0 .5rem; letter-spacing: .3px; }
    .subtitle { color: var(--muted); font-size: .95rem; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.25rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
    }
    .steps { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 850px) { .steps { grid-template-columns: 1fr 1fr; } }
    .step {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1rem;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    }
    .step h2 { display: flex; align-items: baseline; gap: .5rem; font-size: 1.1rem; margin: .25rem 0 .75rem; letter-spacing: .2px; }
    .step h2 .num {
      display: inline-grid; place-items: center; width: 28px; height: 28px;
      background: var(--accent); color: #08111f; font-weight: 700; border-radius: 999px;
    }
    .step p { margin: .25rem 0 .75rem; color: var(--text); }
    .muted { color: var(--muted); }
    img.stepimg {
      width: 100%; height: auto; display: block;
      border-radius: 12px; border: 1px solid var(--border);
    }
    .converter {
      margin-top: 1.25rem; padding: 1rem; border: 1px dashed var(--border);
      border-radius: 12px; background: linear-gradient(180deg, rgba(96,165,250,.08), rgba(96,165,250,.03));
    }
    .controls { display: flex; flex-wrap: wrap; gap: .75rem; align-items: center; margin-top: .5rem; }
    input[type="file"] {
      color: var(--text); background: #0b1221; border: 1px solid var(--border);
      border-radius: 8px; padding: .5rem .75rem;
    }
    button {
      padding: .6rem 1rem; border: 1px solid transparent; border-radius: 999px;
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
      color: #0b1221; font-weight: 700; cursor: pointer; transition: transform .03s ease-in-out;
    }
    button:active { transform: translateY(1px); }
    footer { margin-top: 2rem; color: var(--muted); text-align: center; font-size: .9rem; }
    code.inline {
      padding: 0 .25rem; border-radius: 4px; background: #0b1221;
      border: 1px solid var(--border); color: #93c5fd;
    }
    .report { margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem; }
    .grid { display: grid; gap: .5rem; grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid > div { background:#0b1221; border:1px solid var(--border); border-radius:10px; padding:.75rem; }
    .ok { color: var(--ok); }
    table { width: 100%; border-collapse: collapse; margin-top: .75rem; }
    th, td { border-bottom: 1px solid var(--border); text-align: left; padding: .4rem .25rem; font-size: .95rem; }
    th { color: var(--muted); font-weight: 600; }
    .small { font-size: .9rem; color: var(--muted); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Export → Convert → Import to PMDS</h1>
      <p class="subtitle">Use these steps to export your shopping list from ASA CAPS, convert it to a PMDS-ready text file, and paste it via AccuTerm.</p>
    </header>

    <section class="card">
      <div class="steps">
        <div class="step">
          <h2><span class="num">1</span> Export from the Mitsubishi ASA CAPS shopping list</h2>
          <p>Make sure <strong>“Set All Repl.”</strong> is checked. If you do not do this, the import into PMDS will fail on a supersession. Then click the <strong>Download</strong> icon (down arrow).</p>
          <img class="stepimg" src="step1.png" alt="Step 1 – Set All Repl and click download arrow">
        </div>

        <div class="step">
          <h2><span class="num">2</span> Save as CSV</h2>
          <p>In the menu, choose <strong>CSV format</strong>. Save the file somewhere you'll remember.</p>
          <img class="stepimg" src="step2.png" alt="Step 2 – Choose CSV format">
        </div>

        <div class="step" style="grid-column: 1 / -1">
          <h2><span class="num">3</span> Convert CSV → PMDS TXT (with de-dup)</h2>
          <p>Use the converter below. It replaces commas with tabs, as the Accuterm paste from function recognises tabs as carriage returns. It also appends four trailing tabs per line to get to the next line, <strong>removes duplicate part numbers</strong>, and shows you which lines were duplicated.</p>
          <div class="converter">
            <div class="controls">
              <input type="file" id="csvFile" accept=".csv" />
              <button id="convertBtn" type="button">Convert &amp; Download</button>
            </div>
            <p class="muted small">Assumptions: <strong>Part Number</strong> is column 1 and <strong>Quantity</strong> is column 2.</p>
            <div id="report" class="report" hidden>
              <div class="grid">
                <div>
                  <div>Total lines in file (excluding blanks): <strong id="totalLines">0</strong></div>
                  <div>Data rows exported (after removing): <strong id="exportedRows">0</strong></div>
                </div>
                <div>
                  <div>Duplicate parts removed: <strong id="dupeCount">0</strong></div>
                  <div>Part number column index: <strong id="pnIndex">1</strong></div>
                </div>
              </div>
              <div id="dupeTableWrap"></div>
            </div>
          </div>
        </div>

        <div class="step" style="grid-column: 1 / -1">
          <h2><span class="num">4</span> Import into PMDS (AccuTerm)</h2>
          <p>Load the customer in AccuTerm, then go to <strong>Edit → Paste From…</strong> and select the TXT you just created.</p>
		  <p>You can add back in the duplicate lines after pasting using the '/E(line number)' command in PMDS</p>
          <img class="stepimg" src="step3.png" alt="Step 4 – AccuTerm Edit > Paste From">
        </div>
      </div>
    </section>

    <footer>Tip: After import, quickly verify quantities, part numbers and pricing against the original shopping list.</footer>
  </div>

  <script>
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Parse first N CSV fields with basic quote support (handles commas inside quotes)
    function parseFirstNCSVFields(line, n) {
      var result = [];
      var cur = "";
      var inQuotes = false;
      for (var i = 0; i < line.length; i++) {
        var ch = line[i];
        if (ch === '"') {
          // toggle quotes or escape double quote inside quotes
          if (inQuotes && line[i+1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          result.push(cur);
          cur = "";
          if (result.length === n - 1) {
            // We have n-1 fields; the rest of the line is the nth field
            result.push(line.slice(i + 1));
            return result;
          }
        } else {
          cur += ch;
        }
      }
      result.push(cur);
      // pad if shorter
      while (result.length < n) result.push("");
      return result;
    }

    function convertFile() {
      const input = document.getElementById("csvFile");
      const file = input.files && input.files[0];
      if (!file) { alert("Please select a CSV file first."); return; }

      const reader = new FileReader();
      reader.onload = function(e) {
        const csvText = e.target.result;

        // Original lines (including blanks) to preserve original line numbering
        const rawLines = csvText.split(/\r?\n/);

        const seen = new Map(); // normalizedPN -> { firstLine, pn, quantity }
        const dupes = new Map(); // normalizedPN -> array of { lineNumber, pn, quantity }
        const outputLines = [];

        let totalNonBlank = 0;

        for (let i = 0; i < rawLines.length; i++) {
          const lineNumber = i + 1; // 1-based
          const line = rawLines[i];

          if (!line || !line.trim()) {
            continue; // don't count blank lines as data lines
          }
          totalNonBlank++;

          const fields = parseFirstNCSVFields(line, 2);
          const pnRaw = (fields[0] || "").trim().replace(/^\uFEFF/, ""); // strip BOM if present
          const qtyRaw = (fields[1] || "").trim();

          const normalizedPN = pnRaw.toUpperCase(); // normalise for dedup

          if (!pnRaw) {
            // keep rows without part number
            outputLines.push(line);
            continue;
          }

          if (!seen.has(normalizedPN)) {
            seen.set(normalizedPN, { firstLine: lineNumber, pn: pnRaw, quantity: qtyRaw });
            outputLines.push(line);
          } else {
            const arr = dupes.get(normalizedPN) || [];
            arr.push({ lineNumber, pn: pnRaw, quantity: qtyRaw });
            dupes.set(normalizedPN, arr);
          }
        }

        // Build TXT content: replace commas with tabs + four trailing tabs
        const txtLines = outputLines.map(function(line) {
          return line.replace(/,/g, "\t") + "\t\t\t\t";
        });
        const outputText = txtLines.join("\n");

        // Download result file
        const baseName = file.name.replace(/\.[^/.]+$/, "");
        const newFileName = baseName + "PMDS.txt";
        const blob = new Blob([outputText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = newFileName;
        a.click();
        URL.revokeObjectURL(url);

        // ----- Inline report -----
        const exportedRows = outputLines.length;
        const dupeCount = Array.from(dupes.values()).reduce(function(sum, arr) { return sum + arr.length; }, 0);

        document.getElementById("totalLines").textContent = totalNonBlank;
        document.getElementById("exportedRows").textContent = exportedRows;
        document.getElementById("dupeCount").textContent = dupeCount;
        document.getElementById("pnIndex").textContent = 1;

        const wrap = document.getElementById("dupeTableWrap");
        wrap.innerHTML = "";
        if (dupeCount > 0) {
	var rowsHtml = "";
	Array.from(dupes.keys()).forEach(function(normPN) {
	  var first = seen.get(normPN);
	  var firstRow = true;

	  dupes.get(normPN).forEach(function(d) {
	    rowsHtml += "<tr>"
	      + (firstRow ? "<td>" + escapeHtml(first.pn) + "</td>" : "<td></td>")
	      + (firstRow ? "<td>" + escapeHtml(first.firstLine + " (qty: " + (first.quantity || "—") + ")") + "</td>" : "<td></td>")
	      + "<td>" + escapeHtml(d.lineNumber + " (PN: " + d.pn + ", qty: " + (d.quantity || "—") + ")") + "</td>"
	      + "</tr>";
	    firstRow = false;
	  });
	});

	var tableHtml =
	  "<table>" +
	    "<thead>" +
	      "<tr>" +
	        "<th>Part Number</th>" +
	        "<th>First occurrence line</th>" +
	        "<th>Duplicate line(s) removed</th>" +
	      "</tr>" +
	    "</thead>" +
	    "<tbody>" + rowsHtml + "</tbody>" +
	  "</table>";

	wrap.innerHTML = tableHtml;
        } else {
          const p = document.createElement("p");
          p.className = "ok";
          p.textContent = "No duplicate part numbers detected.";
          wrap.appendChild(p);
        }

        document.getElementById("report").hidden = false;
      };
      reader.onerror = () => alert("Error reading the CSV file.");
      reader.readAsText(file, "utf-8");
    }

    document.getElementById("convertBtn").addEventListener("click", convertFile);
  </script>
</body>
</html>
